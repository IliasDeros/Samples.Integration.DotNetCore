@page
@model Datadeck.Samples.Integration.DotNetCore.Pages.ConnectModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@{
    var AntiXsrfRequestToken = Xsrf.GetAndStoreTokens(Model.HttpContext).RequestToken;
}

<h1>
    Connect your account with us
</h1>

@section Scripts
{
    <script src="https://link.datadeck.co/link-initialize.js"></script>
    <script>
        ; (function linkDemoIIFE(context) {
            context.DatadeckSample = {
                async startLinkSession(
                    {
                        afterLoad = () => { },
                        onError = () => { },
                        onSuccess = () => { },
                    }
                ) {
                    try {
                        // Create a Link session using the link token that was gotten from the backend that called the Datadeck API (/link/token/create)
                        const token = '@Model.DatadeckLinkToken';
                        const handler = Datadeck.create({
                            token,
                            onSuccess,
                        });
                        handler.open();
                    } catch (e) {
                        console.error(e);
                        onError(e);
                    }

                    afterLoad();
                }
            }
        })(window);

        function exchangePublicToken({ public_token }) {
            this.isSuccess = true

            // Call the backend and send the public token that was gotten from the Link session
            $.ajax({
                type: 'POST',
                url: "/Connect",
                data: { public_token },
                success: () => ,
                headers:
                {
                    // This is only required by ASP.NET Razor pages
                    "RequestVerificationToken": "@AntiXsrfRequestToken"
                }
            });
            const isSuccess = !this.demo_public_token;
        }

        function thankRedirect() {
            if (!this.isSuccess) {
              return;
            }

            window.location.href = window.location.href = "/Thanks"
        }

        DatadeckSample.startLinkSession({
            onExit: thankRedirect,
            onSuccess: exchangePublicToken,
        });
    </script>
}
